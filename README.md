# tf-rtlab
Advanced Red Team Lab Infrastructure on Azure using Terraform

# Procedure

**Pre-requisite:** Active Azure Subscription

- Terraform Configuration
    - Configure Cloud Shell
    - Install/Update Terraform
    - Authenticate via a Microsoft account from Cloud Shell (using PowerShell)
        - Create a service principal using Azure PowerShell
        - Specify service principal credentials in environment variables
        - Specify service principal credentials in a Terraform provider block
- VPN certificate generation
- Terraform Deployment
- VPN client configuration

# Configure Cloud Shell

1. Open [Azure Portal](https://portal.azure.com) and login

2. Open Azure Cloud Shell and select "PowerShell" as the interpreter environment

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/b70a7668-b3d9-4565-a2a0-63051174f84f)

3. If this is your first time using the Azure account, when displayed "You have no storage mounted" and prompted to create a file share, select "Show advanced settings"

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/dfc58499-7f74-4b7b-a172-cfc7ca6b7fa2)


4. Select `Subscription`, `Cloud Shell region`, enter names for `Resource group`, `Storage account` and `File share` and press the "Create Storage" button

Note: Storage account must be unique across all Azure subscriptions globally, not just yours. The reason for that is that the name becomes part of the URL, e.g. `https://accountname.blob.core.windows.net`

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/366bceec-bda2-46f6-8589-d7f21c8319d3)


# Install/Update Terraform

1. After getting a Cloud Shell (PS), check if terraform is installed and up to date

```powershell
#Check terraform version to see if it needs an update
terraform version
```

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/1e922d13-e642-4513-8572-49db5ffab60d)


* * *

If the version is out of date, browse to [Terraform Downloads](https://www.terraform.io/downloads.html) and copy the download link of the latest version for Linux - AMD64

- Note: Azure Shell is based on Azure Linux (linux_amd64), so we need the Linux - AMD64 version

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/645af607-190e-4984-a7f8-df9829999e30)


```plaintext
https://releases.hashicorp.com/terraform/1.5.4/terraform_1.5.4_linux_amd64.zip
```

```bash
#Download terraform
curl -O <terraform_download_url>

#Unzip package
unzip <zip_file_downloaded_in_previous_step>

#Create bin directory if not present
mkdir bin

#Move terraform to bin directory
mv terraform bin/
```

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/cb16157a-977f-404f-85b2-2208f913f752)


Restart Cloud Shell

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/4a3ecb70-aa93-4ab8-8439-4e3629d8c2e0)
![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/e278e319-6bb6-4b47-8d15-5aa6084d1536)


Confirm terraform is updated

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/74799227-92d5-48b0-8e56-2893645c34e5)


# Authenticate via a Microsoft account from Cloud Shell (using PowerShell)

```powershell
#Check current subscription
Get-AzSubscription
```

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/b77d3291-1681-4832-a4d8-2a951a58bcdd)


Save both `Subscription ID` and `tenantId` for upcoming steps

## Create a service principal using Azure PowerShell

The most common pattern is to interactively sign in to Azure, create a service principal, test the service principal, and then use that service principal for future authentication (either interactively or from your scripts).

```powershell
#Create service principal with Contributer role
$sp = New-AzADServicePrincipal -DisplayName <service_principal_name> -Role "Contributor"

#Display the App ID
$sp.AppId

#Display the autogenerated password
$sp.PasswordCredentials.SecretText
```

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/e3f15d56-de49-494d-8be4-4ee77fd20d3b)


Save both `AppId` and `PasswordCredentials.SecretText` for upcoming steps

## Specify service principal credentials in environment variables

Replace the following code with respective values gained from earlier steps and execute code to save values as environment variables

```powershell
#Save values as environment variables
$env:ARM_SUBSCRIPTION_ID="<azure_subscription_id>"
$env:ARM_TENANT_ID="<azure_subscription_tenant_id>"
$env:ARM_CLIENT_ID="<service_principal_app_id>"
$env:ARM_CLIENT_SECRET="<service_principal_password>"

#Check the environment variables
gci env:ARM_*
```

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/455ef853-0b81-4155-9a3c-b6a4d57f18fe)


## Specify service principal credentials in a Terraform provider block

1. Clone/Download this GitHub repository on Windows computer

2. Replace fields in `rtlab/Terraform/providers.tf` with respective values

```plaintext
provider "azurerm" {
    features {}
    subscription_id   = "<SUBSCRIPTIONID>"
    tenant_id         = "<TENANTID>"
    client_id         = "<CLIENTID>"
    client_secret     = "<CLIENTSECRET>"
}
```

# VPN certificate generation

Pre-requisites:

- `winget` package manager

1. Execute `p2s-vpn-cert-gen.ps1`

2. Input private key when prompted with `Enter Password to Export Client Cert (with Private Key)`

3. Input private key again when prompted to extract private key details via `openssl`

# Terraform Deployment

1. Create zip archive of the `rtlab` folder

2. Upload zip archive to Azure using Cloud Shell

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/0488feb9-749a-44eb-bb2f-6b26d9d89ccc)


3. Extract archive

4. Run `rtlab\tf-deploy.ps1`

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/6f05c69a-94eb-4a60-bce7-1d3721517ca8)


Wait for deployment to finish (takes around ~45-60 minutes)

### Output

Output containing credentials and SSH keys are displayed on console as well as saved in `rtlab/Terraform/outputs.txt`

```json
{
  "password_admin_ubuntu": {
    "sensitive": true,
    "type": "string",
    "value": "<REDACTED>"
  },
  "password_admin_soc": {
    "sensitive": true,
    "type": "string",
    "value": "<REDACTED>"
  },
  "password_admin_win1": {
    "sensitive": true,
    "type": "string",
    "value": "<REDACTED>"
  },
  "password_admin_win2": {
    "sensitive": true,
    "type": "string",
    "value": "<REDACTED>"
  },
  "password_admin_win3": {
    "sensitive": true,
    "type": "string",
    "value": "<REDACTED>"
  },
  "password_admin_winserver": {
    "sensitive": true,
    "type": "string",
    "value": "<REDACTED>"
  },
  "password_admin_winserver_safemode": {
    "sensitive": true,
    "type": "string",
    "value": "<REDACTED>"
  },
  "key_data_kali": {
    "sensitive": false,
    "type": "string",
    "value": "ssh-rsa <REDACTED> generated-by-azure"
  },
  "key_data_ubuntu": {
    "sensitive": false,
    "type": "string",
    "value": "ssh-rsa <REDACTED> generated-by-azure"
  },
  "resource_group_name": {
    "sensitive": false,
    "type": "string",
    "value": "RTLAB"
  }
}
<REDACTED:VPNClientConfigurationArchiveDownloadURL>
```

# VPN client configuration

1. After successful deployment, download the VPN client configuration archive from the link in the output

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/aa66e16a-5ba9-43aa-8954-f70c619f9da2)


2. Extract archive

3. Copy `PRIVATE KEY` data and `P2SChildCert` data from `rtlab\Terraform\VPNcerts\profileinfo.txt` and put them in `vpnclientconfiguration\OpenVPN\vpnconfig.ovpn` using any text editor

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/5df0b862-caf0-40b5-827d-e1b0ad4347e4)
![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/f70fb95f-56a7-41e1-88ab-20048618d697)
![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/787569b6-f2d7-4f6e-a13e-872302bcabfa)
![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/a124f50e-c0a7-4396-87cc-abaf0988b243)


# Putting VMs to stopped(de-allocated) state

VMs on Azure are billed in both `running` and `stopped` state, as resources remain allocated in the datacenter for these two states. In the `stopped (deallocated)` state, VMs don't incur a cost, although OS disks reserved for the VMs will be still billed.

`rtlab/tf-deploy.ps1` automatically stops all VMs after deployment to save costs. However, after using lab VMs, please use the `rtlab/dealloc-all-vm.ps1` script to deallocate resources and save costs.

![image](https://github.com/hamzajazib/tf-rtlab/assets/82419998/5de59bd0-1d9f-4e79-9323-38243698c7d1)


# Console Output

On the VM console output for the custom script extension can be found in a JSON file located at : `C:\Packages\Plugins\Microsoft.Compute.CustomScriptExtension\<version>\Status`

Azure command execution and script handling logs (i.e logs detailing the downloading and running the script) can be found at : `C:\WindowsAzure\Logs\Plugins\Microsoft.Compute.CustomScriptExtension\<version>`

# Destroying resources

Run `rtlab/tf-destroy.ps1` to automatically destroy all resources created by the Terraform execution plan earlier
